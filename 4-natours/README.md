# Node.js API Design

## Standard folder structure

```python
my-nodejs-app/
├── node_modules/                         # Auto-generated by npm, contains installed dependencies
├── public/                               # Static files like images, CSS, JavaScript
├── src/                                  # Source code
│   ├── config/                           # Configuration files
│   │   ├── db.js                         # Database configuration
│   │   ├── env.js                        # Environment-specific settings
│   │   └── ...                           # Other configuration files
│   ├── controllers/                      # Route handlers
│   │   ├── userController.js             # User-related request handlers
│   │   ├── authController.js             # Authentication-related request handlers
│   │   └── ...                           # Other controllers
│   ├── middlewares/                      # Custom middleware functions
│   │   ├── authMiddleware.js             # Authentication middleware
│   │   ├── errorHandler.js               # Error handling middleware
│   │   └── ...                           # Other middleware functions
│   ├── models/                           # Database models
│   │   ├── user.js                       # User model
│   │   ├── post.js                       # Post model
│   │   └── ...                           # Other models
│   ├── routes/                           # Route definitions
│   │   ├── userRoutes.js                 # User-related routes
│   │   ├── authRoutes.js                 # Authentication-related routes
│   │   └── ...                           # Other route files
│   ├── services/                         # Business logic
│   │   ├── userService.js                # User-related business logic
│   │   ├── authService.js                # Authentication-related business logic
│   │   └── ...                           # Other services
│   ├── utils/                            # Utility functions
│   │   ├── logger.js                     # Logging utility
│   │   ├── validator.js                  # Validation utility
│   │   └── ...                           # Other utilities
│   ├── app.js                            # Main application file
│   └── server.js                         # Server setup and start
├── test/                                 # Test cases
│   ├── controllers/                      # Tests for controllers
│   │   ├── userController.test.js        # Tests for userController
│   │   └── ...                           # Other controller tests
│   ├── middlewares/                      # Tests for middlewares
│   │   ├── authMiddleware.test.js        # Tests for authMiddleware
│   │   └── ...                           # Other middleware tests
│   ├── models/                           # Tests for models
│   │   ├── user.test.js                  # Tests for user model
│   │   └── ...                           # Other model tests
│   ├── routes/                           # Tests for routes
│   │   ├── userRoutes.test.js            # Tests for userRoutes
│   │   └── ...                           # Other route tests
│   ├── services/                         # Tests for services
│   │   ├── userService.test.js           # Tests for userService
│   │   └── ...                           # Other service tests
│   ├── utils/                            # Tests for utilities
│   │   ├── logger.test.js                # Tests for logger utility
│   │   └── ...                           # Other utility tests
│   └── ...                               # Other test files
├── .env                                  # Environment variables
├── .gitignore                            # Git ignore file
├── package.json                          # Project metadata and dependencies
├── package-lock.json                     # Exact versions of installed dependencies
└── README.md                             # Project documentation
```

## Filter, Sort, and Limit

```javascript
const getAllTours = async (req, res) => {
  try {
    // BUILD QUERY

    // 1A. Filtering: Create a copy of the request query object and remove fields that are not used for filtering
    const queryObj = { ...req.query }
    const excludedFields = ['page', 'sort', 'limit', 'fields']
    excludedFields.forEach((field) => delete queryObj[field])

    // 1B. Advanced Filtering: Convert the query object to a string and replace comparison operators with MongoDB operators
    const queryStr = JSON.stringify(queryObj).replace(
      /\b(gte|gt|lte|lt)\b/g,
      (match) => `$${match}`,
    )

    // Create a query object from the modified query string
    let query = Tour.find(JSON.parse(queryStr))

    // 2. Sorting: If a sort parameter is provided, sort by the specified fields; otherwise, sort by creation date in descending order
    if (req.query.sort) {
      const sortBy = req.query.sort.split(',').join(' ')
      query = query.sort(sortBy)
    } else {
      query = query.sort('-createdAt')
    }

    // 3. Field Limiting: If fields parameter is provided, select only those fields; otherwise, exclude the '__v' field
    if (req.query.fields) {
      const fields = req.query.fields.split(',').join(' ')
      query = query.select(fields)
    } else {
      query = query.select('-__v')
    }

    // 4. Pagination: Determine the page number and limit per page, then calculate the number of documents to skip
    const page = Number(req.query.page) || 1
    const limit = Number(req.query.limit) || 100
    const skip = (page - 1) * limit

    // Apply pagination to the query
    query = query.skip(skip).limit(limit)

    // Check if the requested page is valid by comparing the skip value with the total number of documents
    if (req.query.page) {
      const numTours = await Tour.countDocuments()
      if (skip >= numTours) throw new Error('This page does not exist')
    }

    // EXECUTE QUERY: Execute the query to get the tours
    const tours = await query

    // SEND RESPONSE: Send the response with the status, number of results, and the data
    res.status(200).json({
      status: 'success',
      results: tours.length,
      data: { tours },
    })
  } catch (error) {
    // Handle errors: Send a response with the error message
    res.status(400).json({ status: 'fail', message: error.message })
  }
}
```
